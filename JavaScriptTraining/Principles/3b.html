<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Assignment - Fireworks - Karol Strzelecki</title>
    <script src="https://threejs.org/build/three.min.js"></script>

</head>
<body>
<script>

    let scene, camera, renderer,raycaster, mouse, plane, planeNormal,point;
    let stars = [];
    let fires = [];
    let colors = [0xF03C15, 0xC70039, 0xDFF12B, 0x2BF1B5, 0x05B2F8,];
    let ADD = 0.2;
    let dt = 0.03;

    class Fragment {
        constructor(position, velocity) {
            this.velocity = velocity;
            this.velocity.multiplyScalar(dt);

            let starGeometry = new THREE.Geometry();
            starGeometry.vertices.push(new THREE.Vector3( 0, 0, 0));
            let starMaterial = new THREE.PointsMaterial( {
                color: colors[Math.floor(Math.random() * colors.length)],
                size: 4,
                sizeAttenuation: false } );
            this.star = new THREE.Points( starGeometry, starMaterial );

            this.star.position.copy(position);
        }

        move() {
            this.star.position.add(this.velocity);

        }
    }
    let randomRange = function(from, to){
        let x = Math.random() * (to - from);
        return x + from;
    };


    let createGeometry = function(x,y,z) {

        for (let i = 0; i < 70; i++) {

            stars.push(new Fragment(new THREE.Vector3(x, y, z),
                new THREE.Vector3(randomRange(-5, 0), randomRange(0, 5), randomRange(0, 5))));

            stars.push(new Fragment(new THREE.Vector3(x, y, z),
                new THREE.Vector3(randomRange(0, 5), randomRange(0, 5), randomRange(0, 5))));
            stars.push(new Fragment(new THREE.Vector3(x, y, z),
                new THREE.Vector3(randomRange(0, 5), randomRange(-5, 0), randomRange(0, 5))));
            stars.push(new Fragment(new THREE.Vector3(x, y, z),
                new THREE.Vector3(randomRange(-5, 0), randomRange(-5, 0), randomRange(0, 5))));

        }

        stars.forEach(e =>scene.add(e.star));
    };

    let onMouseDown = function(event) {
        getPoint(event);
        setPoint();

    };








    let getPoint= function(event) {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        planeNormal.copy(camera.position).normalize();
        plane.setFromNormalAndCoplanarPoint(planeNormal, scene.position);
        raycaster.setFromCamera(mouse, camera);
        raycaster.ray.intersectPlane(plane, point);
    };

    let setPoint = function() {

        let x = point.x;
        let y = point.y;
        let z = point.z;



                let starGeometry = new THREE.Geometry();
                starGeometry.vertices.push(new THREE.Vector3( 0, 0, 0));
                let starMaterial = new THREE.PointsMaterial( {
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: 4,
                    sizeAttenuation: false } );
                let fire = new THREE.Points( starGeometry, starMaterial );
                let dest = new THREE.Points(starGeometry, starMaterial);
                fire.position.x = x;
                fire.position.y = y-10;
                fire.position.z = z;

                scene.add(fire);

                dest.position.x = x;
                dest.position.y = y;
                dest.position.z = z;

                let arr = [];
                arr.push(fire, dest);

                fires.push(arr);








        //createGeometry(x,y,z);

    };


    let animate = function(){

        for(let i = 0; i<fires.length; i++) {
            fires[i][0].position.y += ADD;

            let tmp1 = fires[i][0].position.y;
            let tmpy = fires[i][1].position.y;
            let tmpx = fires[i][1].position.x;
            let tmpz = fires[i][1].position.z;


            if (tmp1 >= tmpy) {
                createGeometry(tmpx, tmpy, tmpz);
                scene.remove(fires[i][0]);
                //fires.pop();
                //fires.splice(i);
                fires.shift();

            }
        }

            for (let i = 0; i < stars.length; i++) {
                 stars[i].move();
                // if( i > 3000) {
                //     stars.shift();
                //     scene.shift(scene[0]);
//                }
            }

            // let start = Date.now();
            //
            // let bang = false;
            // while (!bang) {
            //     let timer = (Date.now() - start);
            //     if (timer > 500) {
            //         createGeometry(tmpx, tmpy, tmpz);
            //         bang = true;
            //     }
            // }
            // for (let i = 0; i < stars.length; i++) {
            //     stars[i].move();
            // }

    };


    let init = function() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.set(0, 0, 10);
        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);


        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();
        plane = new THREE.Plane();
        planeNormal = new THREE.Vector3();
        point = new THREE.Vector3();

        document.addEventListener("mousedown", onMouseDown, false);
    };

    let mainLoop = function(){

        let timer = Date.now() * 0.0005;

        animate();

        // camera.position.x = Math.cos(timer) *20;
        // camera.position.z = Math.sin(timer) * 20;



        requestAnimationFrame(mainLoop);
        renderer.render(scene, camera);

    };

    // ToDo:
    // Wektor od dołu i na koniec ma się zatrzymac
    // Kolejka na 1500 elementow
    // Matematycznie zrobi koło z wektorow
    // § może zrobic kamerę obracającą się
    //







    init();
    mainLoop();



</script>

</body>
</html>